


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>inferno.trainers.basic &#8212; inferno 0.1.7 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">inferno 0.1.7 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for inferno.trainers.basic</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="k">import</span> <span class="n">signature</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># These are fetched from globals, they&#39;re not unused</span>
<span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="kn">import</span> <span class="nn">dill</span>
<span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="kn">import</span> <span class="nn">pickle</span>


<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">inf</span>
<span class="kn">from</span> <span class="nn">torch.autograd</span> <span class="k">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="k">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">torch.nn.parallel.data_parallel</span> <span class="k">import</span> <span class="n">data_parallel</span>
<span class="kn">from</span> <span class="nn">.callbacks.logging.base</span> <span class="k">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">.callbacks.logging</span> <span class="k">import</span> <span class="n">get_logger</span>

<span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="n">train_utils</span> <span class="k">as</span> <span class="n">tu</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="n">python_utils</span> <span class="k">as</span> <span class="n">pyu</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="n">torch_utils</span> <span class="k">as</span> <span class="n">thu</span>
<span class="kn">from</span> <span class="nn">..extensions</span> <span class="k">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="nn">..extensions</span> <span class="k">import</span> <span class="n">optimizers</span>
<span class="kn">from</span> <span class="nn">..extensions</span> <span class="k">import</span> <span class="n">criteria</span>
<span class="kn">from</span> <span class="nn">.callbacks</span> <span class="k">import</span> <span class="n">CallbackEngine</span>
<span class="kn">from</span> <span class="nn">.callbacks</span> <span class="k">import</span> <span class="n">Console</span>
<span class="kn">from</span> <span class="nn">..utils.exceptions</span> <span class="k">import</span> <span class="n">assert_</span><span class="p">,</span> <span class="n">NotSetError</span><span class="p">,</span> <span class="n">NotTorchModuleError</span><span class="p">,</span> <span class="n">DeviceError</span>


<div class="viewcode-block" id="Trainer"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer">[docs]</a><span class="k">class</span> <span class="nc">Trainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A basic trainer.</span>

<span class="sd">    Given a torch model, this class encapsulates the training and validation loops,</span>
<span class="sd">    checkpoint creation, logging, CPU &lt;-&gt; GPU transfers and managing data-loaders.</span>

<span class="sd">    In addition, this class interacts with the callback engine (found at</span>
<span class="sd">    `inferno.trainers.callbacks.base.CallbackEngine`), which manages callbacks at</span>
<span class="sd">    certain preset events.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Logging is implemented as a special callback, in the sense that it&#39;s jointly</span>
<span class="sd">    managed by the this class and the callback engine. This is primarily because</span>
<span class="sd">    general callbacks are not intended to be serializable, but not being able to</span>
<span class="sd">    serialize the logger is a nuisance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : torch.nn.Module</span>
<span class="sd">            Torch model to bind to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Privates</span>
        <span class="c1"># Core</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_retain_graph</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Metric evaluation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_metric_every</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metric_evaluation_externally_triggered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_metric_evaluated_at_epoch</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_logged</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_directory</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Data logistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loader_iters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loader_specs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Iteration and epoch book-keeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_mode</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span>

        <span class="c1"># GPU and dtype business</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_device_ordinal</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_at_best_validation_score</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_best_validation_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_iteration_with_best_validation_score</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_every</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_validation_iterations</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_batch_dim</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_criterion</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># We should exclude the zero-th epoch from validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_validated_at_epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_validated_at_iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># This is to allow a callback to trigger a validation by setting</span>
        <span class="c1"># trainer.validate_now = True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_externally_triggered</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Checkpointing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_every</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_to_directory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pickle_module</span> <span class="o">=</span> <span class="s1">&#39;pickle&#39;</span>
        <span class="c1"># Defaults for file names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_filename</span> <span class="o">=</span> <span class="s1">&#39;checkpoint.pytorch&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_best_checkpoint_filename</span> <span class="o">=</span> <span class="s1">&#39;best_checkpoint.pytorch&#39;</span>

        <span class="c1"># Nothing to save at epoch 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_saved_at_epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># This is to allow a callback to trigger a save by setting trainer.save_now = True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_externally_triggered</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Stopping conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_num_iterations</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_num_epochs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Callbacks and states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback_engine</span> <span class="o">=</span> <span class="n">CallbackEngine</span><span class="p">()</span><span class="o">.</span><span class="n">bind_trainer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Print console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>

        <span class="c1"># Public</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">console</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the current console.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_console</span>

<div class="viewcode-block" id="Trainer.set_console"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.set_console">[docs]</a>    <span class="k">def</span> <span class="nf">set_console</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">console</span><span class="p">):</span>
        <span class="n">assert_</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">console</span><span class="p">,</span> <span class="n">Console</span><span class="p">),</span> <span class="s2">&quot;`console` must be a Console object.&quot;</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_console</span> <span class="o">=</span> <span class="n">console</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.quiet"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.quiet">[docs]</a>    <span class="k">def</span> <span class="nf">quiet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">toggle_progress</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the callback engine.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback_engine</span>

<div class="viewcode-block" id="Trainer.register_callback"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.register_callback">[docs]</a>    <span class="k">def</span> <span class="nf">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">callback_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a callback with the internal callback engine.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        callback : type or callable</span>
<span class="sd">            Callback to register.</span>
<span class="sd">        trigger : str</span>
<span class="sd">            Specify the event that triggers the callback. Leave at &#39;auto&#39; to have the</span>
<span class="sd">            callback-engine figure out the triggers. See</span>
<span class="sd">            `inferno.training.callbacks.base.CallbackEngine` documentation for more on this.</span>
<span class="sd">        callback_kwargs : dict</span>
<span class="sd">            If `callback` is a type, initialize an instance with these keywords to the</span>
<span class="sd">            __init__ method.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="o">**</span><span class="n">callback_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback_engine</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="n">trigger</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the model.&quot;&quot;&quot;</span>
        <span class="n">assert_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Model is not defined yet.&quot;</span><span class="p">,</span> <span class="n">NotSetError</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>

    <span class="nd">@model</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind_model</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Trainer.bind_model"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.bind_model">[docs]</a>    <span class="k">def</span> <span class="nf">bind_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Binds a model to the trainer. Equivalent to setting model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : torch.nn.Module</span>
<span class="sd">            Model to bind.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assert_</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">),</span>
                <span class="s2">&quot;Model must be a torch.nn.Module.&quot;</span><span class="p">,</span>
                <span class="n">NotTorchModuleError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="c1"># Transfer model to GPU if required</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model_is_defined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">retain_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retain_graph</span>

    <span class="nd">@retain_graph</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">retain_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_retain_graph</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the optimizer.&quot;&quot;&quot;</span>
        <span class="n">assert_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Optimizer is not set yet.&quot;</span><span class="p">,</span> <span class="n">NotSetError</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span>

    <span class="nd">@optimizer</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_optimizer</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_optimizer</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">optimizer_is_defined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="Trainer.build_optimizer"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.build_optimizer">[docs]</a>    <span class="k">def</span> <span class="nf">build_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">param_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds the optimizer for training.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str or callable or torch.optim.Optimizer</span>
<span class="sd">            Name of the optimizer when str, handle to the optimizer class when callable,</span>
<span class="sd">            or a torch.optim.Optimizer instance. If a name is provided, this method looks</span>
<span class="sd">            for the optimizer in `torch.optim` module first and in</span>
<span class="sd">            inferno.extensions.optimizers second.</span>
<span class="sd">        param_groups : list of dict</span>
<span class="sd">            Specifies the parameter group. Defaults to model.parameters() if None.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments to the optimizer.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            if optimizer is not found</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            if method is not str or callable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">optimizer_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">optimizer_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Look for optimizer in extensions</span>
                <span class="n">optimizer_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">optimizers</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">optimizer_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Optimizer </span><span class="si">{}</span><span class="s2"> not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">optimizer_class</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">method</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">param_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">param_groups</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">param_groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">optimizer_class</span><span class="p">(</span><span class="n">param_groups</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the loss criterion.&quot;&quot;&quot;</span>
        <span class="n">assert_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Criterion is not set yet.&quot;</span><span class="p">,</span> <span class="n">NotSetError</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span>

    <span class="nd">@criterion</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_criterion</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_criterion</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Criterion can either be set to a string, callable or a dict. &quot;</span>
                               <span class="n">f</span><span class="s2">&quot;Got {type(value).__name__} instead.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Trainer.build_criterion"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.build_criterion">[docs]</a>    <span class="k">def</span> <span class="nf">build_criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds the loss criterion for training.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str or callable or torch.nn.Module</span>
<span class="sd">            Name of the criterion when str, criterion class when callable, or a</span>
<span class="sd">            torch.nn.Module instance. If a name is provided, this method looks</span>
<span class="sd">            for the criterion in `torch.nn`.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments to the criterion class&#39; constructor if applicable.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            if criterion is not found.</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            if method is neither a str nor a callable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Look for criteria in torch</span>
            <span class="n">criterion_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">criterion_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Look for it in extensions</span>
                <span class="n">criterion_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">criterion_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Criterion </span><span class="si">{}</span><span class="s2"> not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">criterion_class</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span> <span class="o">=</span> <span class="n">method</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span> <span class="o">=</span> <span class="n">criterion_class</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Transfer criterion to GPU if required. This is necessary for e.g. weighted loss,</span>
        <span class="c1"># where the weight is registered as a buffer.</span>
        <span class="c1"># The criterion is to be cuda&#39;ed only if the model is on CUDA (self._use_cuda) and</span>
        <span class="c1"># the base_device is not CPU (ordinal -1).</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_base_device_ordinal&#39;</span><span class="p">):</span>
            <span class="c1"># This is to not break old checkpoints</span>
            <span class="n">base_device_ordinal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_device_ordinal</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_device_ordinal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span> <span class="ow">and</span> <span class="n">base_device_ordinal</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">criterion_is_defined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validation_criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_criterion</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_criterion</span>

    <span class="nd">@validation_criterion</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">validation_criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_validation_criterion</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_validation_criterion</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Validation criterion can either be set to a string, callable &quot;</span>
                               <span class="n">f</span><span class="s2">&quot;or a dict. Got {type(value).__name__} instead.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Trainer.build_validation_criterion"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.build_validation_criterion">[docs]</a>    <span class="k">def</span> <span class="nf">build_validation_criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds the loss criterion for validation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str or callable or torch.nn.Module</span>
<span class="sd">            Name of the criterion when str, criterion class when callable, or a</span>
<span class="sd">            torch.nn.Module instance. If a name is provided, this method looks</span>
<span class="sd">            for the criterion in `torch.nn`.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments to the criterion class&#39; constructor if applicable.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            if criterion is not found.</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            if method is neither a str nor a callable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Look for criteria in torch</span>
            <span class="n">criterion_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">criterion_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Look for it in extensions</span>
                <span class="n">criterion_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">criterion_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Criterion </span><span class="si">{}</span><span class="s2"> not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">criterion_class</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validation_criterion</span> <span class="o">=</span> <span class="n">method</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_criterion</span> <span class="o">=</span> <span class="n">criterion_class</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Transfer criterion to GPU if required. This is necessary for e.g. weighted loss,</span>
        <span class="c1"># where the weight is registered as a buffer.</span>
        <span class="c1"># The criterion is to be cuda&#39;ed only if the model is on CUDA (self._use_cuda) and</span>
        <span class="c1"># the base_device is not CPU (ordinal -1).</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_base_device_ordinal&#39;</span><span class="p">):</span>
            <span class="c1"># This is to not break old checkpoints</span>
            <span class="n">base_device_ordinal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_device_ordinal</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_device_ordinal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span> <span class="ow">and</span> <span class="n">base_device_ordinal</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validation_criterion</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.validation_criterion_is_train_criterion"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.validation_criterion_is_train_criterion">[docs]</a>    <span class="k">def</span> <span class="nf">validation_criterion_is_train_criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yes</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">yes</span><span class="p">:</span>
            <span class="c1"># This will cause the property to return train criterion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validation_criterion</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validation_criterion_is_defined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_criterion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the evaluation metric.&quot;&quot;&quot;</span>
        <span class="n">assert_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Metric is not set yet.&quot;</span><span class="p">,</span> <span class="n">NotSetError</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span>

    <span class="nd">@metric</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_metric</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">evaluating_metric_every</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_metric_every</span>

<div class="viewcode-block" id="Trainer.evaluate_metric_every"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.evaluate_metric_every">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_metric_every</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set frequency of metric evaluation __during training__ (and not during validation).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency : inferno.utils.train_utils.Frequency or str or tuple or list or int</span>
<span class="sd">            Metric evaluation frequency. If str, it could be (say) &#39;10 iterations&#39; or &#39;1 epoch&#39;.</span>
<span class="sd">            If tuple (or list), it could be (10, &#39;iterations&#39;) or (1, &#39;epoch&#39;). If int</span>
<span class="sd">            (say 10), it&#39;s interpreted as (10, &#39;iterations&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_metric_every</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">Frequency</span><span class="o">.</span><span class="n">build_from</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;iterations&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_metric_every</span><span class="o">.</span><span class="n">is_consistent</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">evaluate_metric_now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric_evaluation_externally_triggered</span><span class="p">:</span>
            <span class="c1"># Reset trigger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metric_evaluation_externally_triggered</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_metric_every</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># By default, evaluate metric every time</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_metric_every</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_metric_every</span><span class="o">.</span><span class="n">by_epoch</span><span class="p">:</span>
            <span class="c1"># Don&#39;t evaluate if we&#39;ve done so already this epoch</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_metric_evaluated_at_epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If we haven&#39;t evaluated this epoch, check if we should</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_metric_every</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">epoch_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is reached when evaluate_metric_every is defined and matching by</span>
            <span class="c1"># iteration count</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_metric_every</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">iteration_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span><span class="p">)</span>

    <span class="nd">@evaluate_metric_now</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">evaluate_metric_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metric_evaluation_externally_triggered</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Trainer.build_metric"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.build_metric">[docs]</a>    <span class="k">def</span> <span class="nf">build_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds the metric for evaluation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : callable or str</span>
<span class="sd">            Name of the metric when string, metric class or a callable object</span>
<span class="sd">            when callable. If a name is provided, this method looks for the metric in</span>
<span class="sd">            `inferno.extensions.metrics`.</span>

<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments to the metric class&#39; constructor, if applicable.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError: if the metric is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">method</span><span class="p">),</span> \
                <span class="s2">&quot;Could not find the metric &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">method</span><span class="p">)()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metric_is_defined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if the metric is defined.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="Trainer.eval_mode"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.eval_mode">[docs]</a>    <span class="k">def</span> <span class="nf">eval_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set model, criterion and metric to eval mode&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_mode</span> <span class="o">=</span> <span class="s1">&#39;eval&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion_is_defined</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_is_defined</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.train_mode"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.train_mode">[docs]</a>    <span class="k">def</span> <span class="nf">train_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set model, criterion and metric to train mode&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_mode</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion_is_defined</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_is_defined</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">train_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>

    <span class="nd">@train_loader</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">train_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validate_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validate&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validate&#39;</span><span class="p">)</span>

    <span class="nd">@validate_loader</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">validate_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;validate&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the logger.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span>

    <span class="nd">@logger</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_logger</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_logger</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the log directory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_directory</span>

    <span class="nd">@log_directory</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">log_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the log directory,&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_log_directory</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pickle_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">module_</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pickle_module</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">assert_</span><span class="p">(</span><span class="n">module_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Pickle module not found!&quot;</span><span class="p">,</span> <span class="n">ModuleNotFoundError</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">module_</span>

    <span class="n">_ALLOWED_PICKLE_MODULES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;dill&#39;</span><span class="p">}</span>

    <span class="nd">@pickle_module</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pickle_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">assert_</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;`pickle_module` must be set to a string.&quot;</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span>
        <span class="n">assert_</span><span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ALLOWED_PICKLE_MODULES</span><span class="p">,</span>
                <span class="n">f</span><span class="s2">&quot;Pickle module must be one of </span><span class="si">{self._ALLOWED_PICKLE_MODULES}</span><span class="s2">, &quot;</span>
                <span class="n">f</span><span class="s2">&quot;got </span><span class="si">{value}</span><span class="s2"> instead.&quot;</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pickle_module</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">saving_every</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the frequency at which checkpoints are made.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_every</span>

<div class="viewcode-block" id="Trainer.save_at_best_validation_score"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.save_at_best_validation_score">[docs]</a>    <span class="k">def</span> <span class="nf">save_at_best_validation_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yes</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets whether to save when the validation score is the best seen.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_at_best_validation_score</span> <span class="o">=</span> <span class="n">yes</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">save_now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_externally_triggered</span><span class="p">:</span>
            <span class="c1"># Reset trigger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_externally_triggered</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Save if externally triggered</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_at_best_validation_score</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_iteration_with_best_validation_score</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check if we&#39;re saving by epoch</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_every</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_every</span><span class="o">.</span><span class="n">by_epoch</span><span class="p">:</span>
                <span class="c1"># Don&#39;t save if we&#39;ve already saved once this epoch</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_saved_at_epoch</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If we haven&#39;t saved this epoch, check if we should</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_every</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">epoch_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We&#39;re saving by iterations</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_every</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">_save_every</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">iteration_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span><span class="p">)</span>

    <span class="nd">@save_now</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">save_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Can be set to true to trigger a checkpoint creation..&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_externally_triggered</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Trainer.save_every"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.save_every">[docs]</a>    <span class="k">def</span> <span class="nf">save_every</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">to_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">checkpoint_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">best_checkpoint_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set checkpoint creation frequency.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency : inferno.utils.train_utils.Frequency or tuple or str</span>
<span class="sd">            Checkpoint creation frequency. Examples: &#39;100 iterations&#39; or &#39;1 epochs&#39;.</span>
<span class="sd">        to_directory : str</span>
<span class="sd">            Directory where the checkpoints are to be created.</span>
<span class="sd">        checkpoint_filename : str</span>
<span class="sd">            Name of the checkpoint file.</span>
<span class="sd">        best_checkpoint_filename : str</span>
<span class="sd">            Name of the best checkpoint file.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_every</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">Frequency</span><span class="o">.</span><span class="n">build_from</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;iterations&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_every</span><span class="o">.</span><span class="n">is_consistent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_to_directory</span><span class="p">(</span><span class="n">to_directory</span><span class="p">,</span> <span class="n">checkpoint_filename</span><span class="p">,</span> <span class="n">best_checkpoint_filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">save_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_to_directory</span>

<div class="viewcode-block" id="Trainer.save_to_directory"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.save_to_directory">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkpoint_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">best_checkpoint_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">to_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assert_</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">to_directory</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="n">exception_type</span><span class="o">=</span><span class="ne">TypeError</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">to_directory</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">to_directory</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">to_directory</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_to_directory</span> <span class="o">=</span> <span class="n">to_directory</span>
        <span class="k">if</span> <span class="n">checkpoint_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assert_</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint_filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="n">exception_type</span><span class="o">=</span><span class="ne">TypeError</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_filename</span> <span class="o">=</span> <span class="n">checkpoint_filename</span>
        <span class="k">if</span> <span class="n">best_checkpoint_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assert_</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">best_checkpoint_filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="n">exception_type</span><span class="o">=</span><span class="ne">TypeError</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_checkpoint_filename</span> <span class="o">=</span> <span class="n">best_checkpoint_filename</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validating_every</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_every</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validate_now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_externally_triggered</span><span class="p">:</span>
            <span class="c1"># Reset trigger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validation_externally_triggered</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_every</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_every</span><span class="o">.</span><span class="n">by_epoch</span><span class="p">:</span>
            <span class="c1"># Don&#39;t validate if we&#39;ve done so already this epoch</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_validated_at_epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If we haven&#39;t validated this epoch, check if we should</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_every</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">epoch_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span><span class="p">,</span>
                                                  <span class="n">match_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Don&#39;t validate if we&#39;ve done once already this iteration</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_validated_at_iteration</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If we haven&#39;t validated this iteration, check if we should. The `match_zero` is</span>
                <span class="c1"># redundant, but we&#39;ll leave it on anyway.</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_every</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                       <span class="bp">self</span><span class="o">.</span><span class="n">_validate_every</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">iteration_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span><span class="p">,</span>
                                                  <span class="n">match_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@validate_now</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">validate_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_externally_triggered</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Trainer.validate_every"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.validate_every">[docs]</a>    <span class="k">def</span> <span class="nf">validate_every</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">for_num_iterations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set validation frequency.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency : inferno.utils.train_utils.Frequency or str or tuple or list or int</span>
<span class="sd">            Validation frequency. If str, it could be (say) &#39;10 iterations&#39; or &#39;1 epoch&#39;.</span>
<span class="sd">            If tuple (or list), it could be (10, &#39;iterations&#39;) or (1, &#39;epoch&#39;). If int</span>
<span class="sd">            (say 10), it&#39;s interpreted as (10, &#39;iterations&#39;).</span>
<span class="sd">        for_num_iterations : int</span>
<span class="sd">            Number of iterations to validate for. If not set, the model is validated on</span>
<span class="sd">            the entire dataset (i.e. till the data loader is exhausted).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_every</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">Frequency</span><span class="o">.</span><span class="n">build_from</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;iterations&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_every</span><span class="o">.</span><span class="n">is_consistent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_validation_iterations</span> <span class="o">=</span> <span class="n">for_num_iterations</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iteration_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epoch_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">target_batch_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_batch_dim</span>

    <span class="nd">@target_batch_dim</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">target_batch_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">assert_</span><span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;target_batch_dim must be either 0 or 1, got </span><span class="si">{value}</span><span class="s2"> instead.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">),</span>
                <span class="ne">ValueError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_batch_dim</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Trainer.set_target_batch_dim"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.set_target_batch_dim">[docs]</a>    <span class="k">def</span> <span class="nf">set_target_batch_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_batch_dim</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.build_logger"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.build_logger">[docs]</a>    <span class="k">def</span> <span class="nf">build_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the logger.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        logger : inferno.trainers.callbacks.logging.base.Logger or str or type</span>
<span class="sd">            Must either be a Logger object or the name of a logger or the class of a logger.</span>
<span class="sd">        log_directory : str</span>
<span class="sd">            Path to the directory where the log files are to be stored.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments to the logger class.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">Logger</span><span class="p">):</span>
            <span class="c1"># Set logger and register with the callback engine.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">logger</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;log_directory&#39;</span><span class="p">:</span> <span class="n">log_directory</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">if</span> <span class="n">log_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_log_directory</span><span class="p">(</span><span class="n">log_directory</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.set_log_directory"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.set_log_directory">[docs]</a>    <span class="k">def</span> <span class="nf">set_log_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the directory where the log files are to be stored.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        log_directory : str</span>
<span class="sd">            Directory where the log files are to be stored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_directory</span> <span class="o">=</span> <span class="n">log_directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">set_log_directory</span><span class="p">(</span><span class="n">log_directory</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1"># States that are fetched dynamically from the trainer object via properties are</span>
    <span class="c1"># dynamic states. Such states can not be updated.</span>
    <span class="c1"># The following dictionary maps state keys to the corresponding trainer attribute</span>
    <span class="n">DYNAMIC_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="s1">&#39;current_learning_rate&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="Trainer.update_state"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.update_state">[docs]</a>    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DYNAMIC_STATES</span><span class="p">,</span> \
            <span class="s2">&quot;State at key &#39;</span><span class="si">{}</span><span class="s2">&#39; cannot be updated because it&#39;s dynamic.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.update_state_from_dictionary"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.update_state_from_dictionary">[docs]</a>    <span class="k">def</span> <span class="nf">update_state_from_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
        <span class="c1"># Unwrap variables (or tensors)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="n">state_key</span><span class="p">:</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">state_key</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span></div>

<div class="viewcode-block" id="Trainer.update_state_from_model_state_hooks"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.update_state_from_model_state_hooks">[docs]</a>    <span class="k">def</span> <span class="nf">update_state_from_model_state_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;_state_hooks&#39;</span><span class="p">):</span>
            <span class="n">state_hooks</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;_state_hooks&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state_hooks</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_state_from_dictionary</span><span class="p">(</span><span class="n">state_hooks</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trainer.get_state"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DYNAMIC_STATES</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DYNAMIC_STATES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_learning_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_learning_rate</span><span class="p">()</span>

<div class="viewcode-block" id="Trainer.get_current_learning_rate"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.get_current_learning_rate">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_learning_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the current learning rate.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list or float</span>
<span class="sd">            List of learning rates if there are multiple parameter groups, or a float</span>
<span class="sd">            if there&#39;s just one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">learning_rate</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">]</span>
        <span class="n">learning_rate</span> <span class="o">=</span> <span class="p">[</span><span class="n">_learning_rate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">thu</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">_learning_rate</span><span class="p">)</span> <span class="k">else</span> <span class="n">_learning_rate</span>
                         <span class="k">for</span> <span class="n">_learning_rate</span> <span class="ow">in</span> <span class="n">learning_rate</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pyu</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trainer.cuda"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.cuda">[docs]</a>    <span class="k">def</span> <span class="nf">cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train on the GPU.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        devices : list</span>
<span class="sd">            Specify the ordinals of the devices to use for dataparallel training.</span>

<span class="sd">        base_device : {&#39;cpu&#39;, &#39;cuda&#39;}</span>
<span class="sd">            When using data-parallel training, specify where the result tensors</span>
<span class="sd">            are collected. If &#39;cuda&#39;, the results are collected in `devices[0]`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate base_device</span>
        <span class="n">assert_</span><span class="p">(</span><span class="n">base_device</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">],</span>
                <span class="s2">&quot;`base_device` must either be &#39;cpu&#39; or &#39;cuda&#39;, got </span><span class="si">{}</span><span class="s2"> instead.&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base_device</span><span class="p">),</span>
                <span class="n">DeviceError</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># No data-parallelism, make sure base_device is not CPU</span>
            <span class="n">assert_</span><span class="p">(</span><span class="n">base_device</span> <span class="o">!=</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;Without dataparallelism, `base_device` cannot be &#39;cpu&#39;.&quot;</span><span class="p">,</span>
                    <span class="n">DeviceError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_device_ordinal</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_device</span><span class="p">)</span>
        <span class="c1"># Move model to CUDA</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_is_defined</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="c1"># Move criterion to cuda if base device ordinal is not -1 (i.e. CPU)</span>
        <span class="c1"># (the criterion is evaluated on the base device)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion_is_defined</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_device_ordinal</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion_is_defined</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_device_ordinal</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Criterion is evaluated on the CPU, make sure that&#39;s where it lives</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span> <span class="o">=</span> <span class="n">devices</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.cpu"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.cpu">[docs]</a>    <span class="k">def</span> <span class="nf">cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train on the CPU.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_is_defined</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion_is_defined</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.is_cuda"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.is_cuda">[docs]</a>    <span class="k">def</span> <span class="nf">is_cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether using GPU for training.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span></div>

<div class="viewcode-block" id="Trainer.to_device"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.to_device">[docs]</a>    <span class="k">def</span> <span class="nf">to_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objects</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">objects</span><span class="p">)([</span><span class="bp">self</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">_object</span><span class="p">)</span> <span class="k">for</span> <span class="n">_object</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">objects</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span> <span class="k">else</span> <span class="n">objects</span></div>

<div class="viewcode-block" id="Trainer.apply_model"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.apply_model">[docs]</a>    <span class="k">def</span> <span class="nf">apply_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_base_device_ordinal&#39;</span><span class="p">):</span>
            <span class="c1"># This is to not break old checkpoints</span>
            <span class="n">base_device_ordinal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_device_ordinal</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_device_ordinal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="p">),</span>
                                 <span class="n">output_device</span><span class="o">=</span><span class="n">base_device_ordinal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trainer.cast"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.cast">[docs]</a>    <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objects</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">objects</span><span class="p">)([</span><span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_object</span><span class="p">)</span> <span class="k">for</span> <span class="n">_object</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Cast only the float types, while leaving the ints alone</span>
            <span class="k">if</span> <span class="n">objects</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;HalfTensor&#39;</span><span class="p">,</span> <span class="s1">&#39;FloatTensor&#39;</span><span class="p">,</span> <span class="s1">&#39;DoubleTensor&#39;</span><span class="p">]:</span>
                <span class="n">cast_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cast_fn</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">cast_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast_fn</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">objects</span></div>

<div class="viewcode-block" id="Trainer.set_precision"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.set_precision">[docs]</a>    <span class="k">def</span> <span class="nf">set_precision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set training precision.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dtype : {&#39;double&#39;, &#39;float&#39;, &#39;half&#39;}</span>
<span class="sd">            Training precision.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;half&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span>

    <span class="nd">@dtype</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Trainer.bind_loader"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.bind_loader">[docs]</a>    <span class="k">def</span> <span class="nf">bind_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">num_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bind a data loader to the trainer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : {&#39;train&#39;, &#39;validate&#39;, &#39;test&#39;}</span>
<span class="sd">            Name of the loader, i.e. what it should be used for.</span>
<span class="sd">        loader : torch.utils.data.DataLoader</span>
<span class="sd">            DataLoader object.</span>
<span class="sd">        num_inputs : int</span>
<span class="sd">            Number of input tensors from the `loader`.</span>
<span class="sd">        num_targets : int</span>
<span class="sd">            Number of target tensors from the `loader`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            if name is invalid.</span>
<span class="sd">        TypeError</span>
<span class="sd">            if loader is not a DataLoader instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assert_</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span>
                <span class="s2">&quot;`name` must be one of [&#39;train&#39;, &#39;validate&#39;, &#39;test&#39;]. &quot;</span>
                <span class="s2">&quot;Got </span><span class="si">{}</span><span class="s2"> instead.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                <span class="ne">KeyError</span><span class="p">)</span>
        <span class="n">assert_</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">),</span>
                <span class="s2">&quot;`loader` must be a DataLoader object. &quot;</span>
                <span class="s2">&quot;Got </span><span class="si">{}</span><span class="s2"> instead.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
                <span class="ne">TypeError</span><span class="p">)</span>
        <span class="c1"># Check to see if the loader is actually new. This should usually be True.</span>
        <span class="n">is_new_loader</span> <span class="o">=</span> <span class="n">loader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">loader</span><span class="p">})</span>
        <span class="c1"># We also need to account for the case when a loader is being replaced. When this happens,</span>
        <span class="c1"># the old DataLoaderIter might still have processes running, which we need to kill.</span>
        <span class="k">if</span> <span class="n">is_new_loader</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader_iters</span><span class="p">:</span>
            <span class="c1"># This is when the previous loader already has a DataLoaderIter running.</span>
            <span class="c1"># The DataLoaderIter implements a __del__ method, which shuts down workers.</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader_iters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="c1"># Trainers loaded from pickle files might not have &#39;_loader_specs&#39;, therefore:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_loader_specs&#39;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_loader_specs&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loader_specs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;num_inputs&#39;</span><span class="p">:</span> <span class="n">num_inputs</span><span class="p">,</span>
                                          <span class="s1">&#39;num_targets&#39;</span><span class="p">:</span> <span class="n">num_targets</span><span class="p">}})</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.get_loader_specs"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.get_loader_specs">[docs]</a>    <span class="k">def</span> <span class="nf">get_loader_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader_specs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> \
            <span class="s2">&quot;Could not find specs about loader &#39;</span><span class="si">{}</span><span class="s2">&#39;. Valid loader names are: </span><span class="si">{}</span><span class="s2">&quot;</span> \
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loader_specs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader_specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trainer.fetch_next_batch"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.fetch_next_batch">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_next_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_loader</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">restart_exhausted_generators</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">update_batch_count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_epoch_count_if_generator_exhausted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Check if the iterator is built</span>
        <span class="k">if</span> <span class="n">from_loader</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader_iters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loader_iters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">from_loader</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="p">[</span><span class="n">from_loader</span><span class="p">]</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()})</span>
        <span class="c1"># Try to fetch from iterator</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Fetch</span>
            <span class="n">next_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loader_iters</span><span class="p">[</span><span class="n">from_loader</span><span class="p">])</span>
            <span class="c1"># Verify</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_batch</span><span class="p">(</span><span class="n">next_batch</span><span class="p">,</span> <span class="n">from_loader</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">update_batch_count</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batch_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">next_batch</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="c1"># This if clause prevents infinite recursion if the loader is empty</span>
            <span class="k">if</span> <span class="n">restart_exhausted_generators</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loader_iters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">from_loader</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="p">[</span><span class="n">from_loader</span><span class="p">]</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()})</span>
                <span class="c1"># Update epoch count</span>
                <span class="k">if</span> <span class="n">update_epoch_count_if_generator_exhausted</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">next_epoch</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_next_batch</span><span class="p">(</span><span class="n">from_loader</span><span class="p">,</span> <span class="n">restart_exhausted_generators</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                             <span class="n">update_batch_count</span><span class="o">=</span><span class="n">update_batch_count</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>

<div class="viewcode-block" id="Trainer.verify_batch"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.verify_batch">[docs]</a>    <span class="k">def</span> <span class="nf">verify_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">from_loader</span><span class="p">):</span>
        <span class="n">loader_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loader_specs</span><span class="p">(</span><span class="n">from_loader</span><span class="p">)</span>
        <span class="n">num_inputs</span> <span class="o">=</span> <span class="n">loader_specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_inputs&#39;</span><span class="p">)</span>
        <span class="n">num_targets</span> <span class="o">=</span> <span class="n">loader_specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_targets&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">num_inputs</span><span class="p">,</span> <span class="n">num_targets</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_inputs</span> <span class="o">+</span> <span class="n">num_targets</span><span class="p">,</span> \
                <span class="s2">&quot;Was expecting a batch with </span><span class="si">{}</span><span class="s2"> (= num_inputs) + </span><span class="si">{}</span><span class="s2"> (= num_targets) tensors, &quot;</span> \
                <span class="s2">&quot;got one with </span><span class="si">{}</span><span class="s2"> tensors.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_inputs</span><span class="p">,</span> <span class="n">num_targets</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">num_inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_inputs</span><span class="p">,</span> \
                <span class="s2">&quot;Expecting </span><span class="si">{}</span><span class="s2"> inputs, but the batch contains only </span><span class="si">{}</span><span class="s2"> tensors.&quot;</span> \
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_inputs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">num_targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_targets</span><span class="p">,</span> \
                <span class="s2">&quot;Expecting </span><span class="si">{}</span><span class="s2"> outputs, but the batch contains only </span><span class="si">{}</span><span class="s2"> tensors.&quot;</span> \
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_targets</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">batch</span></div>

<div class="viewcode-block" id="Trainer.split_batch"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.split_batch">[docs]</a>    <span class="k">def</span> <span class="nf">split_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">from_loader</span><span class="p">):</span>
        <span class="n">loader_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loader_specs</span><span class="p">(</span><span class="n">from_loader</span><span class="p">)</span>
        <span class="n">num_inputs</span> <span class="o">=</span> <span class="n">loader_specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_inputs&#39;</span><span class="p">)</span>
        <span class="n">num_targets</span> <span class="o">=</span> <span class="n">loader_specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_targets&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">num_targets</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> \
            <span class="s2">&quot;Can not split batch if both the number of inputs and targets is not known.&quot;</span>
        <span class="k">if</span> <span class="n">num_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Unknown number of inputs</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[:</span><span class="o">-</span><span class="n">num_targets</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="o">-</span><span class="n">num_targets</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">num_targets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Unknown number of targets</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[:</span><span class="n">num_inputs</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="n">num_inputs</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Known number of inputs and targets</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[:</span><span class="n">num_inputs</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="o">-</span><span class="n">num_targets</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">pyu</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trainer.restart_generators"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.restart_generators">[docs]</a>    <span class="k">def</span> <span class="nf">restart_generators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">of_loader</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">of_loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">of_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">of_loader</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> \
                <span class="s2">&quot;Key </span><span class="si">{}</span><span class="s2"> not in loaders (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">of_loader</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="p">))</span>
            <span class="n">of_loader</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">to_iterable</span><span class="p">(</span><span class="n">of_loader</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loader_iters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">from_loader</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="p">[</span><span class="n">from_loader</span><span class="p">]</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
                                   <span class="k">for</span> <span class="n">from_loader</span> <span class="ow">in</span> <span class="n">of_loader</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.wrap_batch"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.wrap_batch">[docs]</a>    <span class="k">def</span> <span class="nf">wrap_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">from_loader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">volatile</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">base_device_ordinal</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_device_ordinal</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_base_device_ordinal&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="c1"># First, send to the right device</span>
        <span class="k">if</span> <span class="n">base_device_ordinal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Both inputs and labels are sent to the device</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">base_device_ordinal</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Input batches go to device, while labels remain on the CPU.</span>
            <span class="c1"># To start, we need the number of input batches, i.e. from_loader must not be None</span>
            <span class="n">assert_</span><span class="p">(</span><span class="n">from_loader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;`from_loader` needs to be specified if base_device_ordinal is -1 &quot;</span>
                    <span class="s2">&quot;(i.e. base device for data-parallel training is CPU).&quot;</span><span class="p">,</span>
                    <span class="ne">ValueError</span><span class="p">)</span>
            <span class="n">loader_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader_specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">from_loader</span><span class="p">)</span>
            <span class="n">assert_</span><span class="p">(</span><span class="n">loader_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;No `loader_spec` found for loader key &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">from_loader</span><span class="p">),</span>
                    <span class="ne">RuntimeError</span><span class="p">)</span>
            <span class="c1"># Get number of targets</span>
            <span class="n">num_targets</span> <span class="o">=</span> <span class="n">loader_spec</span><span class="p">[</span><span class="s1">&#39;num_targets&#39;</span><span class="p">]</span>
            <span class="c1"># Fetch input batches and send&#39;em to device (leave the targets alone)</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[:</span><span class="o">-</span><span class="n">num_targets</span><span class="p">]</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
            <span class="c1"># Finally, build the batch</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">inputs</span> <span class="o">+</span> <span class="n">batch</span><span class="p">[</span><span class="o">-</span><span class="n">num_targets</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Internal Error: Invalid base_device_ordinal: </span><span class="si">{}</span><span class="s2">.&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base_device_ordinal</span><span class="p">))</span>
        <span class="c1"># Cast to the right dtype</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="c1"># Second, wrap as variable</span>
        <span class="n">variable_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch_num</span><span class="p">,</span> <span class="n">_batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">thu</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">_batch</span><span class="p">):</span>
                <span class="c1"># This supresses the volatile deprecated warning</span>
                <span class="c1"># TODO remove after Pytorch 1.0</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                    <span class="n">variable_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">_batch</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="n">requires_grad</span><span class="p">,</span>
                                                   <span class="n">volatile</span><span class="o">=</span><span class="n">volatile</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">pyu</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">_batch</span><span class="p">):</span>
                <span class="c1"># This supresses the volatile deprecated warning</span>
                <span class="c1"># TODO remove after Pytorch 1.0</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                    <span class="n">variable_batch</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Variable</span><span class="p">(</span><span class="n">__batch</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="n">requires_grad</span><span class="p">,</span>
                                                    <span class="n">volatile</span><span class="o">=</span><span class="n">volatile</span><span class="p">)</span>
                                           <span class="k">for</span> <span class="n">__batch</span> <span class="ow">in</span> <span class="n">_batch</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Was Expecting batch at index </span><span class="si">{batch_num}</span><span class="s2"> to be either a &quot;</span>
                                   <span class="n">f</span><span class="s2">&quot;tensor or a list of tensors. Got {type(_batch)} instead.&quot;</span><span class="p">)</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">batch</span><span class="p">)(</span><span class="n">variable_batch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch</span></div>

<div class="viewcode-block" id="Trainer.next_iteration"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.next_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">next_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Trainer.next_epoch"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.next_epoch">[docs]</a>    <span class="k">def</span> <span class="nf">next_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Callback before the end of epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">END_OF_EPOCH</span><span class="p">,</span>
                            <span class="n">epoch_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span><span class="p">,</span>
                            <span class="n">batch_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_count</span><span class="p">,</span>
                            <span class="n">iteration_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Callback after the start of epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">BEGIN_OF_EPOCH</span><span class="p">,</span>
                            <span class="n">epoch_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span><span class="p">,</span>
                            <span class="n">batch_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_count</span><span class="p">,</span>
                            <span class="n">iteration_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trainer.stop_fitting"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.stop_fitting">[docs]</a>    <span class="k">def</span> <span class="nf">stop_fitting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_num_iterations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_num_epochs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># First priority to iteration count</span>
        <span class="k">if</span> <span class="n">max_num_iterations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_num_epochs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_num_iterations</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_max_num_iterations</span> <span class="k">if</span> <span class="n">max_num_iterations</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">max_num_iterations</span>
            <span class="n">assert_</span><span class="p">(</span><span class="n">max_num_iterations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;Neither max_num_iterations nor max_num_epochs was set.&quot;</span><span class="p">,</span>
                    <span class="ne">RuntimeError</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span> <span class="o">&gt;=</span> <span class="n">max_num_iterations</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># max_num_epochs is specified. It could be &#39;auto&#39;, in which case we read from the</span>
            <span class="c1"># class attribute</span>
            <span class="n">max_num_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_num_epochs</span> \
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_num_epochs</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_num_epochs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> \
                <span class="k">else</span> <span class="n">max_num_epochs</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span> <span class="o">&gt;=</span> <span class="n">max_num_epochs</span></div>

    <span class="n">INF_STRINGS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inf&#39;</span><span class="p">,</span> <span class="s1">&#39;infinity&#39;</span><span class="p">,</span> <span class="s1">&#39;infty&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="Trainer.set_max_num_iterations"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.set_max_num_iterations">[docs]</a>    <span class="k">def</span> <span class="nf">set_max_num_iterations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_num_iterations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the maximum number of training iterations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_num_iterations : int or float or str</span>
<span class="sd">            Maximum number of training iterations. If float, it should equal numpy.inf.</span>
<span class="sd">            If str, it should be one of {&#39;inf&#39;, &#39;infinity&#39;, &#39;infty&#39;}.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_num_iterations</span> <span class="o">=</span> \
            <span class="n">inf</span> <span class="k">if</span> <span class="n">max_num_iterations</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INF_STRINGS</span> <span class="k">else</span> <span class="n">max_num_iterations</span>
        <span class="c1"># Validate type</span>
        <span class="n">assert_</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">max_num_iterations</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">max_num_iterations</span> <span class="o">==</span> <span class="n">inf</span><span class="p">,</span>
                <span class="s2">&quot;max_num_iterations must be an integer or numpy.inf, got </span><span class="si">{}</span><span class="s2"> instead.&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">max_num_iterations</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
                <span class="ne">TypeError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_num_iterations</span> <span class="o">=</span> <span class="n">max_num_iterations</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.set_max_num_epochs"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.set_max_num_epochs">[docs]</a>    <span class="k">def</span> <span class="nf">set_max_num_epochs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_num_epochs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the maximum number of training epochs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_num_epochs : int or float or str</span>
<span class="sd">            Maximum number of training epochs. If float, it should equal numpy.inf.</span>
<span class="sd">            If str, it should be one of {&#39;inf&#39;, &#39;infinity&#39;, &#39;infty&#39;}.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_num_epochs</span> <span class="o">=</span> <span class="n">inf</span> <span class="k">if</span> <span class="n">max_num_epochs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INF_STRINGS</span> <span class="k">else</span> <span class="n">max_num_epochs</span>
        <span class="n">assert_</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">max_num_epochs</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">max_num_epochs</span> <span class="o">==</span> <span class="n">inf</span><span class="p">,</span>
                <span class="s2">&quot;max_num_epochs must be an integer or numpy.inf, got </span><span class="si">{}</span><span class="s2"> instead.&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">max_num_epochs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
                <span class="ne">TypeError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_num_epochs</span> <span class="o">=</span> <span class="n">max_num_epochs</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.fit"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_num_iterations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_num_epochs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_num_iterations : int or float or str</span>
<span class="sd">            (Optional) Maximum number of training iterations. Overrides the value set by</span>
<span class="sd">            `Trainer.set_max_num_iterations`. If float, it should equal numpy.inf.</span>
<span class="sd">            If str, it should be one of {&#39;inf&#39;, &#39;infinity&#39;, &#39;infty&#39;}.</span>
<span class="sd">        max_num_epochs : int or float or str</span>
<span class="sd">            (Optional) Maximum number of training epochs. Overrides the value set by</span>
<span class="sd">            `Trainer.set_max_num_epochs`. If float, it should equal numpy.inf.</span>
<span class="sd">            If str, it should be one of {&#39;inf&#39;, &#39;infinity&#39;, &#39;infty&#39;}.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Takes care of:</span>
        <span class="c1">#   - dispatching train</span>
        <span class="c1">#   - validation</span>
        <span class="c1">#   - learning rate scheduling</span>
        <span class="c1">#   - saving</span>

        <span class="n">max_num_iterations</span> <span class="o">=</span> <span class="n">inf</span> <span class="k">if</span> <span class="n">max_num_iterations</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INF_STRINGS</span> <span class="k">else</span> <span class="n">max_num_iterations</span>
        <span class="n">max_num_iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_num_iterations</span> <span class="k">if</span> <span class="n">max_num_iterations</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">max_num_iterations</span>

        <span class="n">max_num_epochs</span> <span class="o">=</span> <span class="n">inf</span> <span class="k">if</span> <span class="n">max_num_epochs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INF_STRINGS</span> <span class="k">else</span> <span class="n">max_num_epochs</span>
        <span class="n">max_num_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_num_epochs</span> <span class="k">if</span> <span class="n">max_num_epochs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">max_num_epochs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">BEGIN_OF_FIT</span><span class="p">,</span>
                            <span class="n">max_num_iterations</span><span class="o">=</span><span class="n">max_num_iterations</span><span class="p">,</span>
                            <span class="n">max_num_epochs</span><span class="o">=</span><span class="n">max_num_epochs</span><span class="p">)</span>

        <span class="c1"># Local clock</span>
        <span class="n">run_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_fitting</span><span class="p">(</span><span class="n">max_num_iterations</span><span class="p">,</span> <span class="n">max_num_epochs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exceeded max number of iterations / epochs, breaking.&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="c1"># Train</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_for</span><span class="p">(</span><span class="n">break_callback</span><span class="o">=</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_fitting</span><span class="p">(</span><span class="n">max_num_iterations</span><span class="p">,</span>
                                                                          <span class="n">max_num_epochs</span><span class="p">))</span>
            <span class="c1"># Check if it&#39;s time to validate</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_now</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_for</span><span class="p">()</span>
            <span class="c1"># Check if it&#39;s time to save</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_now</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">run_num</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Call callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">END_OF_FIT</span><span class="p">,</span>
                            <span class="n">max_num_iterations</span><span class="o">=</span><span class="n">max_num_iterations</span><span class="p">,</span>
                            <span class="n">max_num_epochs</span><span class="o">=</span><span class="n">max_num_epochs</span><span class="p">,</span>
                            <span class="n">num_runs</span><span class="o">=</span><span class="n">run_num</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.apply_model_and_loss"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.apply_model_and_loss">[docs]</a>    <span class="k">def</span> <span class="nf">apply_model_and_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">backward</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_mode</span>
            <span class="n">assert_</span><span class="p">(</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">],</span>
                    <span class="n">f</span><span class="s2">&quot;`mode` must be one of [&#39;train&#39;, &#39;eval&#39;], got </span><span class="si">{mode}</span><span class="s2"> instead.&quot;</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span>
        <span class="c1"># Compute prediction</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_model</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>
        <span class="c1"># Compute loss</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="ow">and</span>
                <span class="s1">&#39;trainer&#39;</span> <span class="ow">in</span> <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="o">.</span><span class="n">forward</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;trainer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;eval&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_criterion</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">if</span> <span class="n">backward</span><span class="p">:</span>
            <span class="c1"># Backprop if required</span>
            <span class="c1"># retain_graph option is needed for some custom</span>
            <span class="c1"># loss functions like malis, False per default</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">retain_graph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retain_graph</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">loss</span></div>

<div class="viewcode-block" id="Trainer.train_for"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.train_for">[docs]</a>    <span class="k">def</span> <span class="nf">train_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_iterations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">break_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Switch model to train mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="p">()</span>
        <span class="c1"># Call callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">BEGIN_OF_TRAINING_RUN</span><span class="p">,</span>
                            <span class="n">num_iterations</span><span class="o">=</span><span class="n">num_iterations</span><span class="p">)</span>
        <span class="c1"># iteration_num is a local clock. There&#39;s the global self._iteration_count that keeps</span>
        <span class="c1"># actual track of the number of iterations - this is updated by the call to</span>
        <span class="c1"># self.next_iteration().</span>
        <span class="n">iteration_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_iterations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iteration_num</span> <span class="o">&gt;=</span> <span class="n">num_iterations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished </span><span class="si">{}</span><span class="s2"> iterations. Breaking...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="c1"># Break if break callback asks us to</span>
            <span class="k">if</span> <span class="n">break_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">break_callback</span><span class="p">(</span><span class="n">iteration_num</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Breaking on request from callback.&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s2">&quot;Training iteration </span><span class="si">{}</span><span class="s2"> (batch </span><span class="si">{}</span><span class="s2"> of epoch </span><span class="si">{}</span><span class="s2">).&quot;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span><span class="p">))</span>
            <span class="c1"># Call callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">BEGIN_OF_TRAINING_ITERATION</span><span class="p">,</span>
                                <span class="n">iteration_num</span><span class="o">=</span><span class="n">iteration_num</span><span class="p">)</span>
            <span class="c1"># Zero out the grads</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># No interrupts while computing - a SIGINT could shoot down the driver if</span>
            <span class="c1"># done at the wrong time. Not sure if this has something to do with pinned memory</span>
            <span class="k">with</span> <span class="n">pyu</span><span class="o">.</span><span class="n">delayed_keyboard_interrupt</span><span class="p">():</span>
                <span class="c1"># Get batch</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_next_batch</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
                <span class="c1"># Send to device and wrap as variable</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">from_loader</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
                <span class="c1"># Separate inputs from targets</span>
                <span class="n">inputs</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">from_loader</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
                <span class="c1"># Apply model, compute loss and backprop</span>
                <span class="n">prediction</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_model_and_loss</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">backward</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                             <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
            <span class="c1"># Compute metric</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_is_defined</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_metric_now</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_metric_evaluated_at_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span>
                <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">to_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                    <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">to_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;training_error&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Update state from computation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;training_inputs&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;training_target&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;training_prediction&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;training_loss&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span>
            <span class="c1"># Update state from model&#39;s state hooks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state_from_model_state_hooks</span><span class="p">()</span>
            <span class="c1"># Update parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="c1"># Call callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">END_OF_TRAINING_ITERATION</span><span class="p">,</span>
                                <span class="n">iteration_num</span><span class="o">=</span><span class="n">iteration_num</span><span class="p">)</span>
            <span class="c1"># Prepare for next iteration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_iteration</span><span class="p">()</span>
            <span class="c1"># Break if validating or saving. It&#39;s important that the next_iteration() method is</span>
            <span class="c1"># called before checking validate_now and save_now - because otherwise, the iteration</span>
            <span class="c1"># counter is never updated after the first save and validate, resulting in an infinite</span>
            <span class="c1"># save + validate loop.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_now</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Breaking to validate.&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_now</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Breaking to save.&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">iteration_num</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">END_OF_TRAINING_RUN</span><span class="p">,</span> <span class="n">num_iterations</span><span class="o">=</span><span class="n">num_iterations</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.validate_for"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.validate_for">[docs]</a>    <span class="k">def</span> <span class="nf">validate_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_iterations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loader_name</span><span class="o">=</span><span class="s1">&#39;validate&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate for a given number of validation (if `num_iterations is not None`)</span>
<span class="sd">        or over the entire (validation) data set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_iterations : int</span>
<span class="sd">            Number of iterations to validate for. To validate on the entire dataset,</span>
<span class="sd">            leave this as `None`.</span>
<span class="sd">        loader_name : str</span>
<span class="sd">            Name of the data loader to use for validation. &#39;validate&#39; is the obvious default.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assert_</span><span class="p">(</span><span class="n">loader_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">],</span>
                <span class="s2">&quot;Invalid `loader_name`: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loader_name</span><span class="p">),</span>
                <span class="ne">ValueError</span><span class="p">)</span>
        <span class="c1"># Average over errors</span>
        <span class="n">validation_error_meter</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">AverageMeter</span><span class="p">()</span>
        <span class="n">validation_loss_meter</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">AverageMeter</span><span class="p">()</span>
        <span class="n">iteration_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_iterations</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_validation_iterations</span> <span class="k">if</span> <span class="n">num_iterations</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">num_iterations</span>

        <span class="c1"># Switch to eval mode (e.g. for batchnorm, etc.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_mode</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">loader_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader_iters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loader_iters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">loader_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="p">[</span><span class="n">loader_name</span><span class="p">]</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()})</span>

        <span class="c1"># If we don&#39;t know num_iterations, we&#39;re validating the entire dataset - so we might as</span>
        <span class="c1"># well restart the loader now</span>
        <span class="k">if</span> <span class="n">num_iterations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_generators</span><span class="p">(</span><span class="n">loader_name</span><span class="p">)</span>

        <span class="c1"># Record the epoch we&#39;re validating in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_validated_at_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_validated_at_iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">BEGIN_OF_VALIDATION_RUN</span><span class="p">,</span>
                            <span class="n">num_iterations</span><span class="o">=</span><span class="n">num_iterations</span><span class="p">,</span>
                            <span class="n">num_iterations_in_generator</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loader_iters</span><span class="p">[</span><span class="n">loader_name</span><span class="p">]),</span>
                            <span class="n">last_validated_at_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_validated_at_epoch</span><span class="p">)</span>



        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_iterations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iteration_num</span> <span class="o">&gt;=</span> <span class="n">num_iterations</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">BEGIN_OF_VALIDATION_ITERATION</span><span class="p">,</span>
                                <span class="n">iteration_num</span><span class="o">=</span><span class="n">iteration_num</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_next_batch</span><span class="p">(</span><span class="n">loader_name</span><span class="p">,</span>
                                              <span class="n">restart_exhausted_generators</span><span class="o">=</span>
                                              <span class="n">num_iterations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                                              <span class="n">update_batch_count</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                              <span class="n">update_epoch_count_if_generator_exhausted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> generator exhausted, breaking.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loader_name</span><span class="p">))</span>
                <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s2">&quot;Validating iteration </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration_num</span><span class="p">))</span>

            <span class="n">no_grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">torch</span><span class="p">,</span> <span class="s1">&#39;no_grad&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span>
            <span class="c1"># Delay SIGINTs till after computation</span>
            <span class="k">with</span> <span class="n">pyu</span><span class="o">.</span><span class="n">delayed_keyboard_interrupt</span><span class="p">(),</span> <span class="n">no_grad</span><span class="p">():</span>
                <span class="c1"># Wrap</span>
                <span class="c1"># FIXME The volatile=True is required for compatibility with older 0.3 code.</span>
                <span class="c1"># FIXME Remove when support is deprecated.</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">from_loader</span><span class="o">=</span><span class="n">loader_name</span><span class="p">,</span> <span class="n">volatile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># Separate</span>
                <span class="n">inputs</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">from_loader</span><span class="o">=</span><span class="n">loader_name</span><span class="p">)</span>
                <span class="c1"># Apply model, compute loss</span>
                <span class="n">output</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_model_and_loss</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">backward</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                         <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">batch_size</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_batch_dim</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch_size</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_batch_dim</span><span class="p">)</span>
            <span class="n">validation_loss_meter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">extract_item</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

            <span class="c1"># Compute validation_error</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_is_defined</span><span class="p">:</span>
                <span class="n">validation_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">to_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                               <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">to_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">validation_error</span><span class="p">):</span>
                    <span class="c1"># Convert to float</span>
                    <span class="n">validation_error</span> <span class="o">=</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">validation_error</span><span class="p">,</span> <span class="n">extract_item</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;validation_error&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">validation_error</span><span class="p">))</span>
                <span class="n">validation_error_meter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">validation_error</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;validation_inputs&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;validation_target&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;validation_prediction&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;validation_loss&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span>
            <span class="c1"># This is here for legacy reasons and will eventually be deprecated.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;validation_input&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="s1">&#39;validation_inputs&#39;</span><span class="p">))</span>
            <span class="c1"># Update from model&#39;s state hooks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state_from_model_state_hooks</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">END_OF_VALIDATION_ITERATION</span><span class="p">,</span>
                                <span class="n">iteration_num</span><span class="o">=</span><span class="n">iteration_num</span><span class="p">)</span>

            <span class="n">iteration_num</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done validating. Logging results...&quot;</span><span class="p">)</span>

        <span class="c1"># Report</span>
        <span class="n">validation_results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;validation_loss&#39;</span><span class="p">:</span> <span class="n">validation_loss_meter</span><span class="o">.</span><span class="n">avg</span><span class="p">,</span>
            <span class="s1">&#39;validation_error&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">validation_error_meter</span><span class="o">.</span><span class="n">avg</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_is_defined</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_validation_results</span><span class="p">(</span><span class="o">**</span><span class="n">validation_results</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validation loss: </span><span class="si">{validation_loss}</span><span class="s2">; validation error: &quot;</span>
                          <span class="s2">&quot;</span><span class="si">{validation_error}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">validation_results</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">END_OF_VALIDATION_RUN</span><span class="p">,</span>
                            <span class="n">validation_loss_meter</span><span class="o">=</span><span class="n">validation_loss_meter</span><span class="p">,</span>
                            <span class="n">validation_error_meter</span><span class="o">=</span>
                            <span class="n">validation_error_meter</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_is_defined</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.record_validation_results"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.record_validation_results">[docs]</a>    <span class="k">def</span> <span class="nf">record_validation_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation_loss</span><span class="p">,</span> <span class="n">validation_error</span><span class="p">):</span>
        <span class="c1"># Update state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;validation_loss_averaged&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">validation_loss</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">validation_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="s1">&#39;validation_error_averaged&#39;</span><span class="p">,</span> <span class="n">thu</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">validation_error</span><span class="p">))</span>
        <span class="c1"># Prefer the error metric (if provided). This should be handled with care -</span>
        <span class="c1"># validation error should either always not be None, or otherwise.</span>
        <span class="n">validation_score</span> <span class="o">=</span> <span class="n">validation_loss</span> <span class="k">if</span> <span class="n">validation_error</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">validation_error</span>
        <span class="c1"># Check if validation error is less than the best so far</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_validation_score</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">validation_score</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_validation_score</span><span class="p">:</span>
            <span class="c1"># Best score so far. The following flag will trigger a save</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_iteration_with_best_validation_score</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_validation_score</span> <span class="o">=</span> <span class="n">validation_score</span></div>

<div class="viewcode-block" id="Trainer.get_config"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.get_config">[docs]</a>    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude_loader</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Returns a config dictionary, like __getstate__. Except optionally without the</span>
        <span class="c1"># data loaders (which might be yuuuuuge if it contains the data)</span>
        <span class="n">config_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="c1"># Loader iterators can&#39;t be pickled</span>
        <span class="k">if</span> <span class="s1">&#39;_loader_iters&#39;</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
            <span class="n">config_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_loader_iters&#39;</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="k">if</span> <span class="n">exclude_loader</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;_loaders&#39;</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="n">config_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_loaders&#39;</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="n">config_dict</span></div>

<div class="viewcode-block" id="Trainer.set_config"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.set_config">[docs]</a>    <span class="k">def</span> <span class="nf">set_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">):</span>
        <span class="c1"># TODO some sanity checks on config_dict (e.g. whether the model is actually a model, etc)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>
        <span class="c1"># Rebind trainer to callback engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">bind_trainer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Have callback engine rebind all callbacks to trainer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">rebind_trainer_to_all_callbacks</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.save"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude_loader</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stash_best_checkpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Log the epoch for save_now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_saved_at_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">BEGIN_OF_SAVE</span><span class="p">,</span>
                            <span class="n">save_to_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_to_directory</span><span class="p">,</span>
                            <span class="n">epoch_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span><span class="p">,</span>
                            <span class="n">batch_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_count</span><span class="p">,</span>
                            <span class="n">iteration_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span><span class="p">,</span>
                            <span class="n">is_iteration_with_best_validation_score</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_iteration_with_best_validation_score</span><span class="p">)</span>

        <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_to_directory</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_filename</span><span class="p">)</span>
        <span class="n">best_checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_to_directory</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_best_checkpoint_filename</span><span class="p">)</span>

        <span class="c1"># Save the state dictionary</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="n">exclude_loader</span><span class="o">=</span><span class="n">exclude_loader</span><span class="p">),</span>
                   <span class="n">checkpoint_path</span><span class="p">,</span>
                   <span class="n">pickle_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_module</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">END_OF_SAVE</span><span class="p">,</span>
                            <span class="n">save_to_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_to_directory</span><span class="p">,</span>
                            <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint_path</span><span class="p">,</span>
                            <span class="n">best_checkpoint_path</span><span class="o">=</span><span class="n">best_checkpoint_path</span><span class="p">,</span>
                            <span class="n">epoch_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_epoch_count</span><span class="p">,</span>
                            <span class="n">batch_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_count</span><span class="p">,</span>
                            <span class="n">iteration_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_iteration_count</span><span class="p">,</span>
                            <span class="n">is_iteration_with_best_validation_score</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_iteration_with_best_validation_score</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_iteration_with_best_validation_score</span> <span class="ow">and</span> <span class="n">stash_best_checkpoint</span><span class="p">:</span>
            <span class="c1"># Do the stashin&#39;</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">best_checkpoint_path</span><span class="p">)</span>

        <span class="c1"># This is required to prevent an infinite save loop?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_iteration_with_best_validation_score</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saved to </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_to_directory</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.save_model"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.save_model">[docs]</a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">to_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_to_directory</span> <span class="k">if</span> <span class="n">to_directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">to_directory</span>
        <span class="c1"># Save the state dictionary</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_directory</span><span class="p">,</span> <span class="s1">&#39;model.pytorch&#39;</span><span class="p">),</span>
                   <span class="n">pickle_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_module</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.load"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the trainer from checkpoint.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        from_directory : str</span>
<span class="sd">            Path to the directory where the checkpoint is located. The filename should be</span>
<span class="sd">            &#39;checkpoint.pytorch&#39; if best=False, or &#39;best_checkpoint.pytorch&#39; if best=True.</span>
<span class="sd">        best : bool</span>
<span class="sd">            Whether to load the best checkpoint. The filename in `from_directory` should be</span>
<span class="sd">            &#39;best_checkpoint.pytorch&#39;.</span>
<span class="sd">        filename : str</span>
<span class="sd">            Overrides the default filename.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Trainer</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">from_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_to_directory</span> <span class="k">if</span> <span class="n">from_directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">from_directory</span>
        <span class="k">assert</span> <span class="n">from_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Nowhere to load from.&quot;</span>
        <span class="c1"># Get file name</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_checkpoint_filename</span> <span class="k">if</span> <span class="n">best</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_filename</span>
        <span class="c1"># Load the dictionary</span>
        <span class="n">config_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">from_directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                                 <span class="n">pickle_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_module</span><span class="p">)</span>
        <span class="c1"># This is required to prevent an infinite save loop?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_iteration_with_best_validation_score</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Set config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.load_model"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.load_model">[docs]</a>    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">from_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_to_directory</span> <span class="k">if</span> <span class="n">from_directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">from_directory</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;model.pytorch&#39;</span> <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">filename</span>
        <span class="c1"># Load the model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">from_directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                           <span class="n">pickle_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_module</span><span class="p">)</span>
        <span class="c1"># Set model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Trainer.load_"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.load_">[docs]</a>    <span class="k">def</span> <span class="nf">load_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Here for legacy reasons - use load instead.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trainer.print"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.print">[docs]</a>    <span class="nd">@pyu</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;please use self.console.{info,progress,warning,debug} instead&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+][</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span> <span class="n">message</span><span class="p">))</span></div>

<div class="viewcode-block" id="Trainer.build"><a class="viewcode-back" href="../../../inferno-apidoc/inferno.trainers.html#inferno.trainers.basic.Trainer.build">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">trainer_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Factory function to build the trainer.&quot;&quot;&quot;</span>
        <span class="c1"># Check if trainer is to be loaded from file</span>
        <span class="k">if</span> <span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;load_from_checkpoint&#39;</span><span class="p">):</span>
            <span class="c1"># Load checkpoint config</span>
            <span class="n">trainer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">save_every</span><span class="p">(</span><span class="o">**</span><span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;checkpoint_config&#39;</span><span class="p">))</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">load_</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trainer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;logger_config&#39;</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">build_logger</span><span class="p">(</span><span class="o">**</span><span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logger_config&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;criterion_config&#39;</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">build_criterion</span><span class="p">(</span><span class="o">**</span><span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;criterion_config&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;optimizer_config&#39;</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">build_optimizer</span><span class="p">(</span><span class="o">**</span><span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer_config&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;metric_config&#39;</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">build_metric</span><span class="p">(</span><span class="o">**</span><span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric_config&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;checkpoint_config&#39;</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">save_every</span><span class="p">(</span><span class="o">**</span><span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;checkpoint_config&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;validation_config&#39;</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">validate_every</span><span class="p">(</span><span class="o">**</span><span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validation_config&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;max_num_iterations&#39;</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">set_max_num_iterations</span><span class="p">(</span><span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_num_iterations&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;max_num_epochs&#39;</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">set_max_num_epochs</span><span class="p">(</span><span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_num_epochs&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">):</span>
                <span class="n">devices</span> <span class="o">=</span> <span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;devices&#39;</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">devices</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;training_precision&#39;</span> <span class="ow">in</span> <span class="n">trainer_config</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="n">trainer_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;training_precision&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">trainer</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">inferno 0.1.7 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Nasim Rahaman.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>